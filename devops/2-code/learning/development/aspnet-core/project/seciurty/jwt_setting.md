# jwt configure

[[Authorization]]
[[jwt]]


- Authentication
    > Identity

- Authorization
    > permissions

## Symmetric

- audience and issuer

server(secured resource)`Audience`   <---------   Client(issuer)`Generates the Jwt token using the same secret key`


````
AddAuthentication(options=>
{
    //常數=Bearer
    options.DefaultAuthenticateScheme=JwtBearerDefaults.AuthenticationScheme;;
    //常數=Bearer
    options.DefaultChallengeScheme=JwtBearerDefaults.AuthenticationScheme;
    }).AddJwtBearer(options=>{
    options.TokenValidationParameters = new TokenValidationParameters()
            {
                // a secret is used to verify the signature
                // like a security password
                // symmetricSecurity(對稱金鑰)，使用相同的金錀進行加密與解密資訊
                IssuerSigningKey = new SymmetricSecurityKey(Encoding.UTF8.GetBytes(builder.Configuration["Jwt:Key"]))
                //default is true
                // 驗證token中的 webserver 聲明是否與 API 信任的頒發者（授權）相同。驗證token的頒發者是否是此API所期望的。
                // 驗證token中的來源提供者是為API期望的相同。
                // where is request get this value from 
                // token為正確api所產生的
                ValidateIssuer=true,
                // 驗證token中的audience是否與audience參數相同，即取得的token是針對該api的
                ValidateAudience=true,
                ValidateActor = true,
                ValidateAudience = true,
                ValidateLifetime = true,
                ValidateIssuerSigningKey = true,
                //"Issuer":"https://localhost:7177/"
                ValidIssuer = builder.Configuration["Jwt:Issuer"],
                //"Audience":"https://localhost:7177"
                ValidAudience = builder.Configuration["Jwt:Audience"],
                
            };
});
````

- 在app.UseAuthorization()前加上`UseAuthentication`
````
//who you are claim to be who you are
app.UseAuthentication()
````

- Jwt token generate helper
````
public class JwtToken
{
    private const string SECRET_KEY="";
    public static readonly SymmetricSecurity SIGNING_KEY=new SymmetricSecurityKey(Encoding.UTF8.GetBytes(SECRET_KEY));

    public static string GenerateJwtToken()
    {
        // also note that securityKey length should be > 256 bit
        // so you have to make sure that your private key has a proper length
        var credentials = new SigningCredentials(SIGNING_KEY,SecurityAlgorithms.HmacSha256);

        //finally create a token
        var header = new JwtHeader(credentials);

        // token will be good for 1 minutes
        DateTime expiry =DateTime.UtcNow.AddMinutes(60);
        int ts =(int)(expiry - new DateTime(1970,1,1)).TotalSeconds;

        var padload = new JwtPayload
        {
            {"sub","testSubject"},
            {"Name","Scott"},
            {"email","smithtest@test.com"},
            {"exp",ts},
            {"iss","https://localhost:44342"},
            {"aud","https://localhost:44342"}
        };

        var secToken=new JwtSecurityToken(header,payload);
        var handler = new JwtSecurityTokenHandler();
        var tokenString=handler.writeToken(secToken);
        console.WriteLine(tokenString);
        console.WriteLine("Consume Token");
        return tokenString;
    }
}
````

## Asymmetic

## 參考連結

[defaultscheme-and-defaultchallengescheme](https://stackoverflow.com/questions/52492666/what-is-the-point-of-configuring-defaultscheme-and-defaultchallengescheme-on-asp)

[//begin]: # "Autogenerated link references for markdown compatibility"
[Authentication]: authentication.md "Authentication"
[jwt]: jwt.md "jwt"
[//end]: # "Autogenerated link references"